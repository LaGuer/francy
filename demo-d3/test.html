<!doctype html>
<html>
<head>
  <title>D3</title>
  <script src="//d3js.org/d3.v4.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
</head>

<body>
<h1>Test D3</h1>
<script>
  var json = {
    "type": "Draw",
    "agent": "Francy",
    "object": {
      "type": "canvas",
      "id": 1,
      "width": 700,
      "height": 700,
      "options": {
        "name": "Canvas Test 1",
        "drawn": false,
        "color": "None"
      },
      "objects": [
        {
          "type": "circle",
          "id": 1,
          "options": {
            "name": "circle1",
            "drawn": false,
            "color": "Blue",
            "draggable": false
          },
          "x": 50,
          "y": 50,
          "r": 20,
          "cx": 0,
          "cy": 0
        },
        {
          "type": "circle",
          "id": 3,
          "options": {
            "name": "circle2",
            "drawn": false,
            "color": "Green",
            "draggable": true
          },
          "x": 100,
          "y": 100,
          "r": 40,
          "cx": 0,
          "cy": 0
        },
        {
          "type": "rectangle",
          "id": 7,
          "options": {
            "name": "box1",
            "drawn": false,
            "color": "Yellow",
            "draggable": false
          },
          "x": 150,
          "y": 150,
          "rx": 0,
          "ry": 0,
          "height": 70,
          "width": 90
        }
      ],
      "links": [{"source": 1, "target": 3}, {"source": 3, "target": 1}],
      "menus": []
    }
  };
  var svg = d3.select("body").append("svg").attr("width", json.object.width).attr("height", json.object.height);
  json.object.objects.forEach(function (o) {

  });
  // links
  var links = svg.selectAll("link")
    .data(json.object.links)
    .enter()
    .append("line")
    .attr("class", "link")
    .attr("x1", function (l) {
      var sourceNode = json.object.objects.filter(function (d, i) {
        return d.id == l.source
      })[0];
      d3.select(this).attr("y1", sourceNode.y);
      return sourceNode.x
    })
    .attr("x2", function (l) {
      var targetNode = json.object.objects.filter(function (d, i) {
        return d.id == l.target
      })[0];
      d3.select(this).attr("y2", targetNode.y);
      return targetNode.x
    })
    .attr("fill", "none")
    .attr("stroke", "black");
  // drag
  var drag = d3.drag()
    .on("drag", function (d, i) {
      d.x += d3.event.dx;
      d.y += d3.event.dy;
      var r = d3.select(this).node().r;
      var sizeW = r ? r.baseVal.value : d3.select(this).node().width.baseVal.value;
      var sizeH = r ? r.baseVal.value : d3.select(this).node().height.baseVal.value;
      var sizePW = d3.select(this).node().parentNode.clientWidth;
      var sizePH = d3.select(this).node().parentNode.clientHeight;
      if (d.x <= sizePW - sizeW && d.x >= sizeW && d.y <= sizePH - sizeH && d.y >= sizeH) {
        d3.select(this).attr("cx", d.x).attr("cy", d.y).attr("x", d.x).attr("y", d.y);

        d3.select('svg').selectAll('.link').each(function (l, li) {
          if (l.source == d.id) {
            d3.select(this).attr("x1", d.x).attr("y1", d.y);
          } else if (l.target == d.id) {
            d3.select(this).attr("x2", d.x).attr("y2", d.y);
          }
        });
      }
    });
  // circles
  svg.selectAll('svg').data(json.object.objects).enter().filter(function (d) {
    return d.type == 'circle';
  }).append("circle").style("fill", function (d) {
    return d.options.color;
  }).attr("r", function (d) {
    return d.r;
  }).attr("cx", function (d) {
    return d.x;
  }).attr("cy", function (d) {
    return d.y;
  }).call(drag);
  // rectangles
  svg.selectAll('svg').data(json.object.objects).enter().filter(function (d) {
    return d.type == 'rectangle';
  }).append("rect").style("fill", function (d) {
    return d.options.color;
  }).attr("x", function (d) {
    return d.x;
  }).attr("y", function (d) {
    return d.y;
  }).attr("width", function (d) {
    return d.width;
  }).attr("height", function (d) {
    return d.height;
  }).call(drag);
</script>
</body>
</html>