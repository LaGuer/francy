<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/render/graph.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/francy.js~Francy.html">Francy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#instance-typedef-Options">Options</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Options">Options</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">render</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/render/base.js~Base.html">Base</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/render/callback.js~CallbackHandler.html">CallbackHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/render/canvas.js~Canvas.html">Canvas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/render/chart.js~Chart.html">Chart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/render/composite.js~Composite.html">Composite</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/render/graph.js~Graph.html">Graph</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/render/menu.js~Menu.html">Menu</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/render/modal.js~Modal.html">Modal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/render/renderer.js~Renderer.html">Renderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/render/window.js~Window.html">Window</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">tracker</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tracker/change.js~Tracker.html">Tracker</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">util</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util/id-utils.js~IDUtils.html">IDUtils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util/json-utils.js~JsonUtils.html">JsonUtils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util/logger.js~Logger.html">Logger</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/render/graph.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import Renderer from &apos;./renderer&apos;;

/* global d3 */

export default class Graph extends Renderer {


  static get colors() {
    return d3.scaleSequential().domain([0, 100]).interpolator(d3.interpolateRainbow);
  }

  static getSymbol(type) {
    if (type === &apos;circle&apos;) {
      return d3.symbolCircle;
    }
    else if (type === &apos;cross&apos;) {
      return d3.symbolCross;
    }
    else if (type === &apos;diamond&apos;) {
      return d3.symbolDiamond;
    }
    else if (type === &apos;square&apos;) {
      return d3.symbolSquare;
    }
    else if (type === &apos;triangle&apos;) {
      return d3.symbolTriangle;
    }
    else if (type === &apos;star&apos;) {
      return d3.symbolStar;
    }
    else if (type === &apos;wye&apos;) {
      return d3.symbolWye;
    }
    else {
      return d3.symbolCircle;
    }
  }

  constructor({ verbose = false, appendTo, callbackHandler }) {
    super({ verbose: verbose, appendTo: appendTo, callbackHandler: callbackHandler });
  }

  render(json) {

    if (!Object.keys(json.canvas.graph).length) {
      return;
    }

    var parent = this.options.appendTo;

    var canvasNodes = json.canvas.graph.nodes ? Object.values(json.canvas.graph.nodes) : [],
      canvasLinks = json.canvas.graph.links ? Object.values(json.canvas.graph.links) : [];

    var svg = parent.select(&apos;g.content&apos;),
      width = +parent.attr(&apos;width&apos;) || d3.select(&apos;body&apos;).node().getBoundingClientRect().width,
      height = +parent.attr(&apos;height&apos;) || d3.select(&apos;body&apos;).node().getBoundingClientRect().height;
    //window.innerWidth ||
    var t = d3.transition().duration(500);

    //Generic gravity for the X position
    var forceX = d3.forceX(-500).strength(0.35);

    //Generic gravity for the Y position - undirected/directed graphs fall here
    var forceY = d3.forceY(500).strength(0.35);

    if (json.canvas.graph.type === &apos;hasse&apos;) {
      //Strong y positioning based on layer
      forceY = d3.forceY(d =&gt; d.layer * (d.size * 5)).strength(1);
    }

    var simulation = d3.forceSimulation()
      .force(&apos;link&apos;, d3.forceLink().id(d =&gt; d.id).strength(0.001))
      .force(&apos;charge&apos;, d3.forceManyBody().strength(-250))
      .force(&apos;collide&apos;, d3.forceCollide(d =&gt; d.size))
      .force(&apos;x&apos;, forceX)
      .force(&apos;y&apos;, forceY)
      .force(&apos;center&apos;, d3.forceCenter(width / 2, height / 2));

    var linkGroup = svg.selectAll(&apos;g.links&apos;);

    if (!linkGroup.node()) {
      linkGroup = svg.append(&apos;g&apos;).attr(&apos;class&apos;, &apos;links&apos;);
    }

    var link = linkGroup.selectAll(&apos;line.link&apos;).data(canvasLinks);

    link.exit().transition(t).remove();

    link = link.enter().append(&apos;line&apos;)
      .attr(&apos;class&apos;, &apos;link&apos;)
      .attr(&apos;id&apos;, d =&gt; `${d.source},${d.target}`);

    if (json.canvas.graph.type === &apos;directed&apos;) {
      // this means we need arrows, so we append the marker
      parent.append(&apos;defs&apos;).selectAll(&apos;marker&apos;)
        .data([&apos;arrow&apos;])
        .enter().append(&apos;marker&apos;)
        .attr(&apos;class&apos;, &apos;arrows&apos;)
        .attr(&apos;id&apos;, d =&gt; d)
        .attr(&apos;viewBox&apos;, &apos;0 -5 10 10&apos;)
        .attr(&apos;refX&apos;, 25)
        .attr(&apos;refY&apos;, 0)
        .attr(&apos;markerWidth&apos;, 10)
        .attr(&apos;markerHeight&apos;, 10)
        .attr(&apos;orient&apos;, &apos;auto&apos;)
        .append(&apos;path&apos;)
        .attr(&apos;d&apos;, &apos;M0,-5L10,0L0,5 L10,0 L0, -5&apos;);
      // update the style of the link
      link.style(&apos;marker-end&apos;, &apos;url(#arrow)&apos;);
    }

    var nodeGroup = svg.selectAll(&apos;g.nodes&apos;);

    if (!nodeGroup.node()) {
      nodeGroup = svg.append(&apos;g&apos;).attr(&apos;class&apos;, &apos;nodes&apos;);
    }

    var node = nodeGroup.selectAll(&apos;path.node&apos;).data(canvasNodes);

    node.exit().transition(t).remove();

    node = node.enter().append(&apos;path&apos;)
      .attr(&apos;d&apos;, d3.symbol().type(d =&gt; Graph.getSymbol(d.type)).size(d =&gt; d.size * 100))
      .attr(&apos;transform&apos;, &apos;translate(0,0)&apos;)
      .attr(&apos;class&apos;, d =&gt; &apos;node&apos; + (d.highlight ? &apos; highlight&apos; : &apos;&apos;))
      .attr(&apos;id&apos;, d =&gt; d.id);

    node.call(d3.drag()
        .on(&apos;start&apos;, dragstarted)
        .on(&apos;drag&apos;, dragged)
        .on(&apos;end&apos;, dragended))
      //.on(&apos;contextmenu&apos;, connectedNodes) //rightclick
      .on(&apos;click&apos;, connectedNodes);
    //.on(&apos;click&apos;, function() { alert(&apos;:)&apos;); });

    // TODO this could be a tooltip tag from json
    node.append(&apos;title&apos;).text(d =&gt; `ID:\t${d.id}\nLayer:\t${d.layer}`);

    var labelGroup = svg.selectAll(&apos;.labels&apos;);

    if (!labelGroup.node()) {
      labelGroup = svg.append(&apos;g&apos;).attr(&apos;class&apos;, &apos;labels&apos;);
    }

    var label = labelGroup.selectAll(&apos;text&apos;).data(canvasNodes);

    label.exit().transition(t).remove();

    label = label.enter().append(&apos;text&apos;)
      .attr(&apos;class&apos;, &apos;label&apos;)
      .text(d =&gt; d.title);

    var legendGroup = parent.selectAll(&apos;.legend&apos;);

    if (!legendGroup.node()) {
      legendGroup = parent.append(&apos;g&apos;).attr(&apos;class&apos;, &apos;legend&apos;);
    }

    // force rebuild legend again
    legendGroup.selectAll(&apos;*&apos;).remove();

    var legend = legendGroup.selectAll(&apos;g&apos;)
      .data(d3.map(canvasNodes, d =&gt; d.layer).values().sort((a, b) =&gt; a.layer &lt; b.layer), d =&gt; d.id);

    legend.exit().transition(t).remove();

    legend = legend.enter()
      .append(&apos;g&apos;)
      .attr(&apos;id&apos;, d =&gt; `legendLayer${d}`)
      .attr(&apos;transform&apos;, function(d, i) {
        let x = 10;
        let y = (i + 1) * 11;
        return `translate(${x},${y})`;
      });

    legend.append(&apos;rect&apos;)
      .attr(&apos;width&apos;, 10)
      .attr(&apos;height&apos;, 8)
      .style(&apos;fill&apos;, d =&gt; Graph.colors(d.layer * 6))
      .style(&apos;stroke&apos;, d =&gt; Graph.colors(d.layer * 6));

    legend.append(&apos;text&apos;)
      .attr(&apos;style&apos;, &apos;font-size: 10px;&apos;)
      .attr(&apos;x&apos;, 10 + 5)
      .attr(&apos;y&apos;, 10 - 2)
      .text(d =&gt; `Index ${d.layer}`);

    simulation.nodes(canvasNodes).on(&apos;tick&apos;, ticked);

    simulation.force(&apos;link&apos;).links(canvasLinks);

    function ticked() {
      link
        .attr(&apos;x1&apos;, d =&gt; d.source.x)
        .attr(&apos;y1&apos;, d =&gt; d.source.y)
        .attr(&apos;x2&apos;, d =&gt; d.target.x)
        .attr(&apos;y2&apos;, d =&gt; d.target.y);

      node
        .style(&apos;fill&apos;, d =&gt; Graph.colors(d.layer * 6))
        .attr(&apos;transform&apos;, d =&gt; `translate(${d.x},${d.y})`);

      label
        .attr(&apos;x&apos;, d =&gt; d.x - d.title.length - Math.sqrt(d.size))
        .attr(&apos;y&apos;, d =&gt; d.y - Math.sqrt(d.size));

      node.each(collide(0.9));
    }

    // COLLISION
    var padding = 1; // separation between circles;

    function collide(alpha) {
      let quadTree = d3.quadtree(canvasNodes);
      return function(d) {
        let rb = 2 * d.size + padding,
          nx1 = d.x - rb,
          nx2 = d.x + rb,
          ny1 = d.y - rb,
          ny2 = d.y + rb;
        quadTree.visit(function(quad, x1, y1, x2, y2) {
          if (quad.point &amp;&amp; (quad.point !== d)) {
            let x = d.x - quad.point.x,
              y = d.y - quad.point.y,
              l = Math.sqrt(x * x + y * y);
            if (l &lt; rb) {
              l = (l - rb) / l * alpha;
              d.x -= x *= l;
              d.y -= y *= l;
              quad.point.x += x;
              quad.point.y += y;
            }
          }
          return x1 &gt; nx2 || x2 &lt; nx1 || y1 &gt; ny2 || y2 &lt; ny1;
        });
      };
    }

    // HIGHLIGHT
    //Toggle stores whether the highlighting is on
    var toggle = 0;
    //Create an array logging what is connected to what
    var linkedByIndex = {};

    for (let i = 0; i &lt; canvasNodes.length; i++) {
      linkedByIndex[`${i},${i}`] = 1;
    }

    canvasLinks.forEach(function(d) {
      linkedByIndex[`${d.source.index},${d.target.index}`] = 1;
    });

    //This function looks up whether a pair are neighbours
    function neighboring(a, b) {
      return linkedByIndex[`${a.index},${b.index}`];
    }

    function connectedNodes() {
      d3.event.preventDefault();
      if (toggle === 0) {
        //Reduce the opacity of all but the neighbouring nodes
        let d = d3.select(this).node().__data__;
        node.style(&apos;opacity&apos;, o =&gt; neighboring(d, o) || neighboring(o, d) ? 1 : 0.1);
        link.style(&apos;opacity&apos;, o =&gt; d.index === o.source.index || d.index === o.target.index ? 1 : 0.1);
        //Reduce the op
        toggle = 1;
      }
      else {
        //Put them back to opacity=1
        node.style(&apos;opacity&apos;, 1);
        link.style(&apos;opacity&apos;, 1);
        toggle = 0;
      }
    }

    function dragstarted(d) {
      if (!d3.event.active) {
        simulation.alphaTarget(0.3).restart();
      }
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function dragended(d) {
      if (!d3.event.active) {
        simulation.alphaTarget(0);
      }
      d.fx = null;
      d.fy = null;
    }

  }

}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
